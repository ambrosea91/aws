AWSTemplateFormatVersion: '2010-09-09'
Description: 'PostgreSQL 14 Global Database with Primary in us-east-2 and Secondary in us-west-2'

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - test
      - prod
    Description: Environment name

  DBMasterUsername:
    Type: String
    Default: postgres
    Description: Master username for the database
    NoEcho: false

  DBMasterPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Master password for the database (min 8 characters)

  DBInstanceClass:
    Type: String
    Default: db.r5.large
    Description: Database instance class
    AllowedValues:
      - db.r5.large
      - db.r5.xlarge
      - db.r5.2xlarge
      - db.r6g.large
      - db.r6g.xlarge

  EngineVersion:
    Type: String
    Default: '14.9'
    Description: Aurora PostgreSQL 14 engine version

Resources:
  # VPC and Networking for Primary Region (us-east-2)
  PrimaryVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.2.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-vpc'

  PrimarySubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PrimaryVPC
      CidrBlock: 10.2.1.0/24
      AvailabilityZone: us-east-2a
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-subnet-1'

  PrimarySubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PrimaryVPC
      CidrBlock: 10.2.2.0/24
      AvailabilityZone: us-east-2b
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-subnet-2'

  PrimarySubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PrimaryVPC
      CidrBlock: 10.2.3.0/24
      AvailabilityZone: us-east-2c
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-subnet-3'

  PrimaryDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for PostgreSQL 14 primary cluster
      SubnetIds:
        - !Ref PrimarySubnet1
        - !Ref PrimarySubnet2
        - !Ref PrimarySubnet3
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-subnet-group'

  PrimarySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for PostgreSQL 14 primary cluster
      VpcId: !Ref PrimaryVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 10.2.0.0/16
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-sg'

  # Global Database Cluster
  GlobalCluster:
    Type: AWS::RDS::GlobalCluster
    Properties:
      GlobalClusterIdentifier: !Sub '${Environment}-postgres14-global'
      Engine: aurora-postgresql
      EngineVersion: !Ref EngineVersion
      DatabaseName: mydb
      StorageEncrypted: true

  # Primary DB Cluster (us-east-2)
  PrimaryDBCluster:
    Type: AWS::RDS::DBCluster
    DependsOn: GlobalCluster
    Properties:
      DBClusterIdentifier: !Sub '${Environment}-postgres14-primary-cluster'
      Engine: aurora-postgresql
      EngineVersion: !Ref EngineVersion
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Ref DBMasterPassword
      DatabaseName: mydb
      DBSubnetGroupName: !Ref PrimaryDBSubnetGroup
      VpcSecurityGroupIds:
        - !Ref PrimarySecurityGroup
      GlobalClusterIdentifier: !Ref GlobalCluster
      BackupRetentionPeriod: 7
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      StorageEncrypted: true
      EnableCloudwatchLogsExports:
        - postgresql
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-cluster'
        - Key: Environment
          Value: !Ref Environment

  # Primary DB Instances
  PrimaryDBInstance1:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${Environment}-postgres14-primary-instance-1'
      DBClusterIdentifier: !Ref PrimaryDBCluster
      DBInstanceClass: !Ref DBInstanceClass
      Engine: aurora-postgresql
      EngineVersion: !Ref EngineVersion
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-instance-1'
        - Key: Environment
          Value: !Ref Environment

  PrimaryDBInstance2:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${Environment}-postgres14-primary-instance-2'
      DBClusterIdentifier: !Ref PrimaryDBCluster
      DBInstanceClass: !Ref DBInstanceClass
      Engine: aurora-postgresql
      EngineVersion: !Ref EngineVersion
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-postgres14-primary-instance-2'
        - Key: Environment
          Value: !Ref Environment

Outputs:
  GlobalClusterIdentifier:
    Description: Global Cluster Identifier
    Value: !Ref GlobalCluster
    Export:
      Name: !Sub '${Environment}-postgres14-global-cluster-id'

  PrimaryClusterEndpoint:
    Description: Primary cluster writer endpoint
    Value: !GetAtt PrimaryDBCluster.Endpoint.Address
    Export:
      Name: !Sub '${Environment}-postgres14-primary-endpoint'

  PrimaryClusterReadEndpoint:
    Description: Primary cluster reader endpoint
    Value: !GetAtt PrimaryDBCluster.ReadEndpoint.Address
    Export:
      Name: !Sub '${Environment}-postgres14-primary-read-endpoint'

  PrimaryClusterIdentifier:
    Description: Primary DB Cluster Identifier
    Value: !Ref PrimaryDBCluster
    Export:
      Name: !Sub '${Environment}-postgres14-primary-cluster-id'

  PrimaryVPCId:
    Description: Primary VPC ID
    Value: !Ref PrimaryVPC
    Export:
      Name: !Sub '${Environment}-postgres14-primary-vpc-id'

  EngineVersion:
    Description: PostgreSQL Engine Version
    Value: !Ref EngineVersion
    Export:
      Name: !Sub '${Environment}-postgres14-engine-version'
