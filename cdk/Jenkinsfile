pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'us-east-2'  // Updated to us-east-2
        PRIMARY_REGION = 'us-east-2'
        SECONDARY_REGION = 'us-west-2'
        AWS_ACCOUNT_ID = credentials('aws-account-id')
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        GITHUB_TOKEN = credentials('github-token')
        EC2_KEY_PAIR_NAME = credentials('ec2-key-pair-name')
        SONARQUBE_URL = credentials('sonarqube-url')  // e.g., http://sonarqube:9000
        SONAR_TOKEN = credentials('sonar-token')
        SONAR_PROJECT_KEY = 'cdk-infrastructure'
    }

    tools {
        nodejs 'NodeJS-20'
    }

    options {
        // Build Timeout
        timeout(time: 60, unit: 'MINUTES')
        // Discard old builds
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // Timestamps in console output
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'Code checked out successfully'
            }
        }

        stage('Install Dependencies - MySQL') {
            steps {
                dir('mysql') {
                    sh 'npm install'
                }
            }
        }

        stage('Install Dependencies - PostgreSQL') {
            steps {
                dir('postgres') {
                    sh 'npm install'
                }
            }
        }

        stage('Install Dependencies - EC2') {
            steps {
                dir('ec2-instances') {
                    sh 'npm install'
                }
            }
        }

        stage('Build - MySQL') {
            steps {
                dir('mysql') {
                    sh 'npm run build'
                }
            }
        }

        stage('Build - PostgreSQL') {
            steps {
                dir('postgres') {
                    sh 'npm run build'
                }
            }
        }

        stage('Build - EC2') {
            steps {
                dir('ec2-instances') {
                    sh 'npm run build'
                }
            }
        }

        stage('CDK Synth - MySQL') {
            steps {
                dir('mysql') {
                    sh 'npm run synth'
                }
            }
        }

        stage('CDK Synth - PostgreSQL') {
            steps {
                dir('postgres') {
                    sh 'npm run synth'
                }
            }
        }

        stage('CDK Synth - EC2') {
            steps {
                dir('ec2-instances') {
                    sh 'npm run synth'
                }
            }
        }

        stage('Security Scan') {
            steps {
                script {
                    echo 'Running security audit - will fail on high/critical vulnerabilities'
                    dir('mysql') {
                        sh 'npm audit --audit-level=high'
                    }
                    dir('postgres') {
                        sh 'npm audit --audit-level=high'
                    }
                    dir('ec2-instances') {
                        sh 'npm audit --audit-level=high'
                    }
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    echo 'Running SonarQube code quality analysis'

                    try {
                        // Install SonarScanner if not already installed
                        sh '''
                            if ! command -v sonar-scanner &> /dev/null; then
                                echo "SonarScanner not found, using npx sonarqube-scanner"
                                npm install -g sonarqube-scanner
                            fi
                        '''

                        // Run SonarQube analysis for each stack
                        def stacks = ['mysql', 'postgres', 'ec2-instances']
                        stacks.each { stack ->
                            dir(stack) {
                                sh """
                                    sonar-scanner \
                                      -Dsonar.projectKey=${SONAR_PROJECT_KEY}-${stack} \
                                      -Dsonar.sources=lib,bin \
                                      -Dsonar.host.url=${SONARQUBE_URL} \
                                      -Dsonar.login=${SONAR_TOKEN} \
                                      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
                                      -Dsonar.typescript.tsconfigPath=tsconfig.json \
                                      -Dsonar.exclusions=node_modules/**,cdk.out/**,*.js.map \
                                      -Dsonar.projectVersion=${env.BUILD_NUMBER}
                                """
                            }
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  SonarQube analysis failed or not configured: ${e.message}"
                        echo "Continuing pipeline..."
                    }
                }
            }
        }

        stage('SonarQube Quality Gate') {
            steps {
                script {
                    echo 'Checking SonarQube Quality Gate status'
                    timeout(time: 5, unit: 'MINUTES') {
                        // Wait for SonarQube analysis to complete and check quality gate
                        // Note: waitForQualityGate() uses the analysis from the previous SonarQube scan
                        try {
                            def qualityGate = waitForQualityGate()
                            if (qualityGate.status != 'OK') {
                                error "SonarQube Quality Gate failed: ${qualityGate.status}"
                            }
                            echo "‚úÖ SonarQube Quality Gate passed"
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è  SonarQube Quality Gate check failed or not configured: ${e.message}"
                            echo "Continuing pipeline..."
                        }
                    }
                }
            }
        }

        // Note: Pull Requests are created MANUALLY by developers on GitHub
        // Jenkins runs checks when PR is created
        // This ensures proper review and approval process

        stage('Deploy to AWS') {
            when {
                anyOf {
                    branch 'master'
                    branch 'main'
                }
            }
            steps {
                script {
                    echo 'üöÄ Preparing deployment to AWS...'

                    // Request deployment approval
                    timeout(time: 30, unit: 'MINUTES') {
                        input message: 'üîê Deploy infrastructure to AWS?',
                              ok: 'Deploy',
                              submitter: 'admin,devops'  // Restrict who can approve
                    }

                    echo 'üì¶ Starting deployment...'

                    // Deploy MySQL Aurora Stack (Primary Region: us-east-2)
                    stage('Deploy MySQL - Primary (us-east-2)') {
                        dir('mysql') {
                            echo 'üóÑÔ∏è  Deploying MySQL Aurora to us-east-2...'
                            sh '''
                                export CDK_DEFAULT_REGION=us-east-2
                                export PRIMARY_REGION=us-east-2
                                npm run deploy -- --require-approval never
                            '''
                            echo '‚úÖ MySQL Primary deployed successfully'
                        }
                    }

                    // Deploy PostgreSQL Aurora Stack (Primary Region: us-east-2)
                    stage('Deploy PostgreSQL - Primary (us-east-2)') {
                        dir('postgres') {
                            echo 'üêò Deploying PostgreSQL Aurora to us-east-2...'
                            sh '''
                                export CDK_DEFAULT_REGION=us-east-2
                                export PRIMARY_REGION=us-east-2
                                npm run deploy -- --require-approval never
                            '''
                            echo '‚úÖ PostgreSQL Primary deployed successfully'
                        }
                    }

                    // Deploy EC2 Stack (us-east-2)
                    stage('Deploy EC2 Instances (us-east-2)') {
                        dir('ec2-instances') {
                            echo 'üñ•Ô∏è  Deploying EC2 instances to us-east-2...'
                            sh '''
                                export CDK_DEFAULT_REGION=us-east-2
                                npm run deploy -- --require-approval never
                            '''
                            echo '‚úÖ EC2 instances deployed successfully'
                        }
                    }

                    echo 'üéâ All stacks deployed successfully!'
                }
            }
        }

        stage('Post-Deployment Verification') {
            when {
                anyOf {
                    branch 'master'
                    branch 'main'
                }
            }
            steps {
                script {
                    echo 'üîç Verifying deployment...'

                    // Get stack outputs
                    sh '''
                        echo "=== MySQL Stack Outputs ==="
                        aws cloudformation describe-stacks \
                            --stack-name MysqlAuroraPrimaryStack \
                            --region us-east-2 \
                            --query 'Stacks[0].Outputs' || echo "Stack not found"

                        echo "=== PostgreSQL Stack Outputs ==="
                        aws cloudformation describe-stacks \
                            --stack-name PostgresAuroraPrimaryStack \
                            --region us-east-2 \
                            --query 'Stacks[0].Outputs' || echo "Stack not found"

                        echo "=== EC2 Stack Outputs ==="
                        aws cloudformation describe-stacks \
                            --stack-name Ec2Stack \
                            --region us-east-2 \
                            --query 'Stacks[0].Outputs' || echo "Stack not found"
                    '''

                    echo '‚úÖ Deployment verification complete'
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
            emailext (
                subject: "Jenkins Build SUCCESS: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                    Build succeeded!

                    Job: ${env.JOB_NAME}
                    Build Number: ${env.BUILD_NUMBER}
                    Build URL: ${env.BUILD_URL}
                """,
                to: "${env.CHANGE_AUTHOR_EMAIL}",
                from: "jenkins@yourcompany.com"
            )
        }
        failure {
            echo 'Pipeline failed!'
            emailext (
                subject: "Jenkins Build FAILED: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                    Build failed!

                    Job: ${env.JOB_NAME}
                    Build Number: ${env.BUILD_NUMBER}
                    Build URL: ${env.BUILD_URL}

                    Please check the console output for details.
                """,
                to: "${env.CHANGE_AUTHOR_EMAIL}",
                from: "jenkins@yourcompany.com"
            )
        }
        always {
            cleanWs()
        }
    }
}
