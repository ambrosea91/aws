name: Blue-Green Database Upgrade

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to upgrade'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod
      database_type:
        description: 'Database type to upgrade'
        required: true
        type: choice
        options:
          - mysql
          - postgres
          - both
      region:
        description: 'Region to deploy blue-green automation'
        required: true
        default: 'us-east-2'
        type: choice
        options:
          - us-east-2
          - us-west-2
      action:
        description: 'Blue-Green Action'
        required: true
        type: choice
        options:
          - deploy-automation
          - start-upgrade
          - perform-switchover
          - cleanup
      source_cluster_id:
        description: 'Source Cluster Identifier (required for start-upgrade)'
        required: false
        type: string
      deployment_id:
        description: 'Blue-Green Deployment ID (required for switchover/cleanup)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy-mysql-bluegreen-automation:
    name: Deploy MySQL Blue-Green Automation
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'deploy-automation' && (github.event.inputs.database_type == 'mysql' || github.event.inputs.database_type == 'both') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: ${{ github.event.inputs.region }}

      - name: Deploy MySQL Blue-Green Automation Stack
        run: |
          aws cloudformation deploy \
            --template-file rds-blue-green-upgrade/mysql-bluegreen-upgrade.yaml \
            --stack-name ${{ github.event.inputs.environment }}-mysql-bluegreen \
            --parameter-overrides \
              Environment=${{ github.event.inputs.environment }} \
            --capabilities CAPABILITY_IAM \
            --region ${{ github.event.inputs.region }}

      - name: Get Stack Outputs
        run: |
          echo "Getting Stack Outputs..."
          aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-mysql-bluegreen \
            --region ${{ github.event.inputs.region }} \
            --query 'Stacks[0].Outputs' \
            --output table

  deploy-postgres-bluegreen-automation:
    name: Deploy PostgreSQL Blue-Green Automation
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'deploy-automation' && (github.event.inputs.database_type == 'postgres' || github.event.inputs.database_type == 'both') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: ${{ github.event.inputs.region }}

      - name: Deploy PostgreSQL Blue-Green Automation Stack
        run: |
          aws cloudformation deploy \
            --template-file rds-blue-green-upgrade/postgres-bluegreen-upgrade.yaml \
            --stack-name ${{ github.event.inputs.environment }}-postgres-bluegreen \
            --parameter-overrides \
              Environment=${{ github.event.inputs.environment }} \
            --capabilities CAPABILITY_IAM \
            --region ${{ github.event.inputs.region }}

      - name: Get Stack Outputs
        run: |
          echo "Getting Stack Outputs..."
          aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-postgres-bluegreen \
            --region ${{ github.event.inputs.region }} \
            --query 'Stacks[0].Outputs' \
            --output table

  start-mysql-upgrade:
    name: Start MySQL Blue-Green Upgrade
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'start-upgrade' && github.event.inputs.database_type == 'mysql' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: ${{ github.event.inputs.region }}

      - name: Validate Input
        run: |
          if [ -z "${{ github.event.inputs.source_cluster_id }}" ]; then
            echo "Error: source_cluster_id is required for start-upgrade action"
            exit 1
          fi

      - name: Get State Machine ARN
        id: get-state-machine
        run: |
          STATE_MACHINE_ARN=$(aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-mysql-bluegreen \
            --region ${{ github.event.inputs.region }} \
            --query 'Stacks[0].Outputs[?OutputKey==`StateMachineArn`].OutputValue' \
            --output text)
          echo "state_machine_arn=$STATE_MACHINE_ARN" >> $GITHUB_OUTPUT

      - name: Start Step Functions Execution
        run: |
          EXECUTION_NAME="mysql-upgrade-$(date +%Y%m%d-%H%M%S)"

          aws stepfunctions start-execution \
            --state-machine-arn ${{ steps.get-state-machine.outputs.state_machine_arn }} \
            --name $EXECUTION_NAME \
            --input '{
              "sourceClusterIdentifier": "${{ github.event.inputs.source_cluster_id }}",
              "targetEngineVersion": "8.0.mysql_aurora.3.04.1",
              "blueGreenDeploymentName": "'$EXECUTION_NAME'"
            }' \
            --region ${{ github.event.inputs.region }}

          echo "Started blue-green upgrade execution: $EXECUTION_NAME"
          echo "Monitor progress in Step Functions console or SNS notifications"

  start-postgres-upgrade:
    name: Start PostgreSQL Blue-Green Upgrade
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'start-upgrade' && github.event.inputs.database_type == 'postgres' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: ${{ github.event.inputs.region }}

      - name: Validate Input
        run: |
          if [ -z "${{ github.event.inputs.source_cluster_id }}" ]; then
            echo "Error: source_cluster_id is required for start-upgrade action"
            exit 1
          fi

      - name: Get State Machine ARN
        id: get-state-machine
        run: |
          STATE_MACHINE_ARN=$(aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-postgres-bluegreen \
            --region ${{ github.event.inputs.region }} \
            --query 'Stacks[0].Outputs[?OutputKey==`StateMachineArn`].OutputValue' \
            --output text)
          echo "state_machine_arn=$STATE_MACHINE_ARN" >> $GITHUB_OUTPUT

      - name: Start Step Functions Execution
        run: |
          EXECUTION_NAME="postgres-upgrade-$(date +%Y%m%d-%H%M%S)"

          aws stepfunctions start-execution \
            --state-machine-arn ${{ steps.get-state-machine.outputs.state_machine_arn }} \
            --name $EXECUTION_NAME \
            --input '{
              "sourceClusterIdentifier": "${{ github.event.inputs.source_cluster_id }}",
              "targetEngineVersion": "16.1",
              "blueGreenDeploymentName": "'$EXECUTION_NAME'"
            }' \
            --region ${{ github.event.inputs.region }}

          echo "Started blue-green upgrade execution: $EXECUTION_NAME"
          echo "Monitor progress in Step Functions console or SNS notifications"

  perform-switchover:
    name: Perform Blue-Green Switchover
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'perform-switchover' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: ${{ github.event.inputs.region }}

      - name: Validate Input
        run: |
          if [ -z "${{ github.event.inputs.deployment_id }}" ]; then
            echo "Error: deployment_id is required for perform-switchover action"
            exit 1
          fi

      - name: Perform Switchover
        run: |
          echo "Performing switchover for deployment: ${{ github.event.inputs.deployment_id }}"

          aws rds switchover-blue-green-deployment \
            --blue-green-deployment-identifier ${{ github.event.inputs.deployment_id }} \
            --switchover-timeout 300 \
            --region ${{ github.event.inputs.region }}

          echo "Switchover initiated successfully"
          echo "This will take several minutes to complete"
          echo "Monitor the RDS console for status updates"

  cleanup:
    name: Cleanup Blue-Green Deployment
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'cleanup' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: ${{ github.event.inputs.region }}

      - name: Validate Input
        run: |
          if [ -z "${{ github.event.inputs.deployment_id }}" ]; then
            echo "Error: deployment_id is required for cleanup action"
            exit 1
          fi

      - name: Delete Blue-Green Deployment
        run: |
          echo "Deleting blue-green deployment: ${{ github.event.inputs.deployment_id }}"

          aws rds delete-blue-green-deployment \
            --blue-green-deployment-identifier ${{ github.event.inputs.deployment_id }} \
            --delete-target true \
            --region ${{ github.event.inputs.region }}

          echo "Blue-green deployment cleanup initiated"
          echo "Old (blue) environment will be deleted"

  summary:
    name: Action Summary
    runs-on: ubuntu-latest
    needs: [deploy-mysql-bluegreen-automation, deploy-postgres-bluegreen-automation, start-mysql-upgrade, start-postgres-upgrade, perform-switchover, cleanup]
    if: always()

    steps:
      - name: Print Summary
        run: |
          echo "================================"
          echo "Blue-Green Deployment Action: ${{ github.event.inputs.action }}"
          echo "================================"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Database Type: ${{ github.event.inputs.database_type }}"
          echo "Region: ${{ github.event.inputs.region }}"
          echo ""

          case "${{ github.event.inputs.action }}" in
            deploy-automation)
              echo "✓ Blue-Green automation infrastructure deployed"
              echo "Next: Run 'start-upgrade' action with your source cluster ID"
              ;;
            start-upgrade)
              echo "✓ Blue-Green upgrade process started"
              echo "Next: Monitor SNS notifications and Step Functions execution"
              echo "      Test the green environment when ready"
              echo "      Run 'perform-switchover' when satisfied with testing"
              ;;
            perform-switchover)
              echo "✓ Switchover initiated"
              echo "Next: Verify application connectivity to upgraded database"
              echo "      Run 'cleanup' action to remove old environment"
              ;;
            cleanup)
              echo "✓ Blue-Green deployment cleaned up"
              echo "Upgrade process complete!"
              ;;
          esac
