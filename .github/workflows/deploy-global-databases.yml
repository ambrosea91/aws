name: Deploy RDS Global Databases

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod
      database_type:
        description: 'Database type to deploy'
        required: true
        type: choice
        options:
          - mysql-57
          - postgres-14
          - both
      db_password:
        description: 'Database master password (min 8 characters)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy-mysql:
    name: Deploy MySQL 5.7 Global Database
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.database_type == 'mysql-57' || github.event.inputs.database_type == 'both' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials for Primary Region (us-east-2)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: us-east-2

      - name: Deploy MySQL 5.7 Primary Region (us-east-2)
        run: |
          aws cloudformation deploy \
            --template-file rds-global-databases/mysql-57-primary.yaml \
            --stack-name ${{ github.event.inputs.environment }}-mysql57-primary \
            --parameter-overrides \
              Environment=${{ github.event.inputs.environment }} \
              DBMasterPassword=${{ github.event.inputs.db_password }} \
            --capabilities CAPABILITY_IAM \
            --region us-east-2

      - name: Get Global Cluster ID
        id: get-global-cluster
        run: |
          GLOBAL_CLUSTER_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-mysql57-primary \
            --region us-east-2 \
            --query 'Stacks[0].Outputs[?OutputKey==`GlobalClusterIdentifier`].OutputValue' \
            --output text)
          echo "global_cluster_id=$GLOBAL_CLUSTER_ID" >> $GITHUB_OUTPUT
          echo "Global Cluster ID: $GLOBAL_CLUSTER_ID"

      - name: Configure AWS credentials for Secondary Region (us-west-2)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: us-west-2

      - name: Deploy MySQL 5.7 Secondary Region (us-west-2)
        run: |
          aws cloudformation deploy \
            --template-file rds-global-databases/mysql-57-secondary.yaml \
            --stack-name ${{ github.event.inputs.environment }}-mysql57-secondary \
            --parameter-overrides \
              Environment=${{ github.event.inputs.environment }} \
              GlobalClusterIdentifier=${{ steps.get-global-cluster.outputs.global_cluster_id }} \
            --capabilities CAPABILITY_IAM \
            --region us-west-2

      - name: Get Deployment Outputs
        run: |
          echo "==================================="
          echo "MySQL 5.7 Global Database Deployed"
          echo "==================================="
          echo ""
          echo "PRIMARY REGION (us-east-2):"
          aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-mysql57-primary \
            --region us-east-2 \
            --query 'Stacks[0].Outputs' \
            --output table
          echo ""
          echo "SECONDARY REGION (us-west-2):"
          aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-mysql57-secondary \
            --region us-west-2 \
            --query 'Stacks[0].Outputs' \
            --output table

  deploy-postgres:
    name: Deploy PostgreSQL 14 Global Database
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.database_type == 'postgres-14' || github.event.inputs.database_type == 'both' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials for Primary Region (us-east-2)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: us-east-2

      - name: Deploy PostgreSQL 14 Primary Region (us-east-2)
        run: |
          aws cloudformation deploy \
            --template-file rds-global-databases/postgres-14-primary.yaml \
            --stack-name ${{ github.event.inputs.environment }}-postgres14-primary \
            --parameter-overrides \
              Environment=${{ github.event.inputs.environment }} \
              DBMasterPassword=${{ github.event.inputs.db_password }} \
            --capabilities CAPABILITY_IAM \
            --region us-east-2

      - name: Get Global Cluster ID
        id: get-postgres-global-cluster
        run: |
          GLOBAL_CLUSTER_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-postgres14-primary \
            --region us-east-2 \
            --query 'Stacks[0].Outputs[?OutputKey==`GlobalClusterIdentifier`].OutputValue' \
            --output text)
          echo "global_cluster_id=$GLOBAL_CLUSTER_ID" >> $GITHUB_OUTPUT
          echo "Global Cluster ID: $GLOBAL_CLUSTER_ID"

      - name: Configure AWS credentials for Secondary Region (us-west-2)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::906266478329:role/GitHubActionsOIDCRole
          aws-region: us-west-2

      - name: Deploy PostgreSQL 14 Secondary Region (us-west-2)
        run: |
          aws cloudformation deploy \
            --template-file rds-global-databases/postgres-14-secondary.yaml \
            --stack-name ${{ github.event.inputs.environment }}-postgres14-secondary \
            --parameter-overrides \
              Environment=${{ github.event.inputs.environment }} \
              GlobalClusterIdentifier=${{ steps.get-postgres-global-cluster.outputs.global_cluster_id }} \
            --capabilities CAPABILITY_IAM \
            --region us-west-2

      - name: Get Deployment Outputs
        run: |
          echo "==========================================="
          echo "PostgreSQL 14 Global Database Deployed"
          echo "==========================================="
          echo ""
          echo "PRIMARY REGION (us-east-2):"
          aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-postgres14-primary \
            --region us-east-2 \
            --query 'Stacks[0].Outputs' \
            --output table
          echo ""
          echo "SECONDARY REGION (us-west-2):"
          aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.environment }}-postgres14-secondary \
            --region us-west-2 \
            --query 'Stacks[0].Outputs' \
            --output table

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-mysql, deploy-postgres]
    if: always()

    steps:
      - name: Print Deployment Summary
        run: |
          echo "================================"
          echo "RDS Global Database Deployment Complete"
          echo "================================"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Database Type: ${{ github.event.inputs.database_type }}"
          echo ""
          echo "Consolidated Deployment:"
          echo "- Primary Region: us-east-2"
          echo "- Secondary Region: us-west-2"
          echo "- Both regions deployed in a single CloudFormation stack"
          echo ""
          echo "Next Steps:"
          echo "1. Verify database connectivity in both regions"
          echo "2. Test replication between primary and secondary"
          echo "3. When ready, use the blue-green deployment workflow to upgrade"
